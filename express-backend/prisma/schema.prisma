generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  admin
  field_officer
  citizen
}

enum PotholeSeverity {
  Critical
  High
  Medium
  Low
}

enum PotholeStatus {
  Pending
  Under_Review @map("Under Review")
  Verified
  Assigned
  In_Progress @map("In Progress")
  Completed
  Rejected
  Duplicate
}

enum ReportSource {
  Mobile_App @map("Mobile App")
  AI_Detection @map("AI Detection")
  Admin_Portal @map("Admin Portal")
  Field_Officer @map("Field Officer")
}

enum ComplaintStatus {
  Submitted
  Under_Review @map("Under Review")
  Assigned
  In_Progress @map("In Progress")
  Resolved
  Closed
  Rejected
}

enum ComplaintPriority {
  Urgent
  High
  Medium
  Low
}

enum NotificationType {
  status_update
  complaint_resolved
  new_assignment
  system_alert
  reminder
}

enum VerificationStatus {
  pending
  verified
  rejected
}

enum DevicePlatform {
  android
  ios
  web
}

// Models

model User {
  id              String   @id @default(uuid()) @db.Uuid
  email           String   @unique @db.VarChar(255)
  password        String   @db.VarChar(255)
  
  full_name       String   @db.VarChar(255)
  phone           String?  @db.VarChar(20)
  profile_image_url String? 
  
  role            UserRole @default(citizen)
  is_active       Boolean  @default(true)
  is_email_verified Boolean @default(false)
  is_phone_verified Boolean @default(false)
  
  address         String?
  city            String?  @db.VarChar(100)
  state           String?  @db.VarChar(100)
  
  total_reports   Int      @default(0)
  verified_reports Int     @default(0)
  reputation_score Int     @default(0)
  
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  
  // Relations
  refreshTokens   RefreshToken[]
  deviceTokens    DeviceToken[]
  complaints      Complaint[]        @relation("ReportedComplaints")
  assignedComplaints Complaint[]     @relation("AssignedComplaints")
  verifiedComplaints Complaint[]     @relation("VerifiedComplaints")
  resolvedComplaints Complaint[]     @relation("ResolvedComplaints")
  
  createdPotholes Potholes[]         @relation("CreatedPotholes")
  assignedPotholes Potholes[]        @relation("AssignedPotholes")
  completedPotholes Potholes[]       @relation("CompletedPotholes")
  qualityCheckedPotholes Potholes[]  @relation("QualityCheckedPotholes")
  
  complaintUpdates ComplaintUpdate[]
  potholeHistory   PotholeHistory[]
  notifications    Notification[]
  upvotes          ComplaintUpvote[]
  feedback         ComplaintFeedback[]
  
  announcements    Announcement[]
  appSettings      AppSetting[]
  
  uploadedComplaintImages ComplaintImage[]
  uploadedPotholeImages   PotholeImage[]
  activityLogs            ActivityLog[]
}

model RefreshToken {
  id             String         @id @default(uuid()) @db.Uuid
  user_id        String         @db.Uuid
  user           User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  token          String         @unique
  device_id      String?
  device_platform DevicePlatform?
  expires_at     DateTime
  created_at     DateTime       @default(now())
  is_revoked     Boolean        @default(false)
}

model DeviceToken {
  id             String         @id @default(uuid()) @db.Uuid
  user_id        String         @db.Uuid
  user           User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  device_id      String
  fcm_token      String // Firebase token
  device_platform DevicePlatform
  is_active      Boolean        @default(true)
  updated_at     DateTime       @updatedAt
  
  @@unique([user_id, device_id])
}

model Ward {
  id             Int       @id @default(autoincrement())
  ward_number    String    @unique @db.VarChar(50)
  ward_name      String    @db.VarChar(255)
  ward_officer_name String?
  
  // Relations
  complaints     Complaint[]
  potholes       Potholes[]
  stats          WardStatistic[]
}

model RepairTeam {
  id             Int       @id @default(autoincrement())
  team_code      String    @unique @db.VarChar(50)
  team_name      String    @db.VarChar(100)
  team_leader_name String?
  
  is_active      Boolean   @default(true)
  is_available   Boolean   @default(true)
  
  // Relations
  assignedComplaints Complaint[]
  assignedPotholes   Potholes[]
}

model Complaint {
  id             Int       @id @default(autoincrement())
  complaint_number String  @unique @db.VarChar(50)
  
  user_id        String?   @db.Uuid
  user           User?     @relation("ReportedComplaints", fields: [user_id], references: [id])
  
  citizen_name   String
  citizen_email  String
  citizen_phone  String
  
  title          String
  description    String
  category       String    @default("pothole")
  
  priority       ComplaintPriority @default(Medium)
  status         ComplaintStatus   @default(Submitted)
  severity       PotholeSeverity?
  
  location_address String
  landmark       String?
  ward_id        Int?
  ward           Ward?     @relation(fields: [ward_id], references: [id])
  
  // Simple coordinate storage
  latitude       Float
  longitude      Float
  
  assigned_to_team_id Int?
  assigned_team  RepairTeam? @relation(fields: [assigned_to_team_id], references: [id])
  assigned_by    String?   @db.Uuid
  assignedBy     User?     @relation("AssignedComplaints", fields: [assigned_by], references: [id])
  
  verified_by    String?   @db.Uuid
  verifiedBy     User?     @relation("VerifiedComplaints", fields: [verified_by], references: [id])
  verification_status VerificationStatus @default(pending)
  
  resolved_by    String?   @db.Uuid
  resolvedBy     User?     @relation("ResolvedComplaints", fields: [resolved_by], references: [id])
  
  upvotes_count  Int       @default(0)
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt
  
  images         ComplaintImage[]
  updates        ComplaintUpdate[]
  upvotes        ComplaintUpvote[]
  feedback       ComplaintFeedback[]
  notifications  Notification[]
  
  related_pothole_id Int? // Manual link if needed
}

model ComplaintImage {
  id             Int       @id @default(autoincrement())
  complaint_id   Int
  complaint      Complaint @relation(fields: [complaint_id], references: [id], onDelete: Cascade)
  image_url      String
  image_thumbnail_url String?
  image_type     String    @default("evidence")
  is_primary     Boolean   @default(false)
  
  uploaded_by    String?   @db.Uuid
  uploadedBy     User?     @relation(fields: [uploaded_by], references: [id])
}

model Potholes {
  id             Int       @id @default(autoincrement())
  pothole_number String    @unique
  
  original_complaint_id Int?
  
  location_address String
  ward_id        Int
  ward           Ward      @relation(fields: [ward_id], references: [id])
  
  severity       PotholeSeverity
  status         PotholeStatus   @default(Verified)
  
  created_by     String    @db.Uuid
  createdBy      User      @relation("CreatedPotholes", fields: [created_by], references: [id])
  
  assigned_team_id Int?
  assignedTeam   RepairTeam? @relation(fields: [assigned_team_id], references: [id])
  assigned_by    String?   @db.Uuid
  assignedBy     User?     @relation("AssignedPotholes", fields: [assigned_by], references: [id])
  
  completed_by   String?   @db.Uuid
  completedBy    User?     @relation("CompletedPotholes", fields: [completed_by], references: [id])
  
  quality_checked_by String? @db.Uuid
  qualityCheckedBy User?   @relation("QualityCheckedPotholes", fields: [quality_checked_by], references: [id])
  
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt
  
  images         PotholeImage[]
  history        PotholeHistory[]
}

model PotholeImage {
  id             Int       @id @default(autoincrement())
  pothole_id     Int
  pothole        Potholes  @relation(fields: [pothole_id], references: [id], onDelete: Cascade)
  image_url      String
  image_type     String?
  uploaded_by    String?   @db.Uuid
  uploadedBy     User?     @relation(fields: [uploaded_by], references: [id])
}

model ComplaintUpdate {
  id             Int       @id @default(autoincrement())
  complaint_id   Int
  complaint      Complaint @relation(fields: [complaint_id], references: [id], onDelete: Cascade)
  updated_by     String?   @db.Uuid
  updatedBy      User?     @relation(fields: [updated_by], references: [id])
  update_type    String?
  message        String?
  created_at     DateTime  @default(now())
}

model PotholeHistory {
  id             Int       @id @default(autoincrement())
  pothole_id     Int
  pothole        Potholes  @relation(fields: [pothole_id], references: [id], onDelete: Cascade)
  changed_by     String?   @db.Uuid
  changedBy      User?     @relation(fields: [changed_by], references: [id])
  action         String
  created_at     DateTime  @default(now())
}

model Notification {
  id             String    @id @default(uuid()) @db.Uuid
  user_id        String    @db.Uuid
  user           User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  title          String
  body           String
  type           NotificationType
  related_complaint_id Int?
  relatedComplaint Complaint? @relation(fields: [related_complaint_id], references: [id])
  is_read        Boolean   @default(false)
  created_at     DateTime  @default(now())
}

model ComplaintUpvote {
  id             Int       @id @default(autoincrement())
  complaint_id   Int
  complaint      Complaint @relation(fields: [complaint_id], references: [id], onDelete: Cascade)
  user_id        String    @db.Uuid
  user           User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  created_at     DateTime  @default(now())
  
  @@unique([complaint_id, user_id])
}

model ComplaintFeedback {
  id             Int       @id @default(autoincrement())
  complaint_id   Int
  complaint      Complaint @relation(fields: [complaint_id], references: [id], onDelete: Cascade)
  user_id        String    @db.Uuid
  user           User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  rating         Int
  feedback_text  String?
  created_at     DateTime  @default(now())
}

model Announcement {
  id             Int       @id @default(autoincrement())
  title          String
  message        String
  is_active      Boolean   @default(true)
  created_by     String?   @db.Uuid
  createdBy      User?     @relation(fields: [created_by], references: [id])
  created_at     DateTime  @default(now())
}

model AppSetting {
  id             Int       @id @default(autoincrement())
  setting_key    String    @unique
  setting_value  String?
  is_public      Boolean   @default(false)
  updated_by     String?   @db.Uuid
  updatedBy      User?     @relation(fields: [updated_by], references: [id])
}

model FAQ {
  id             Int       @id @default(autoincrement())
  question       String
  answer         String
  category       String?
  is_active      Boolean   @default(true)
}

model WardStatistic {
  id             Int       @id @default(autoincrement())
  ward_id        Int
  ward           Ward      @relation(fields: [ward_id], references: [id])
  stat_date      DateTime  @db.Date
  total_complaints Int     @default(0)
  // Add other stats as needed
}

model ActivityLog {
  id             String    @id @default(uuid()) @db.Uuid
  user_id        String?   @db.Uuid
  user           User?     @relation(fields: [user_id], references: [id])
  action         String
  entity_type    String?
  created_at     DateTime  @default(now())
}
