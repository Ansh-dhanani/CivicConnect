# CivicConnect Backend API - Complete Routes & Logic Documentation

**Version:** 2.0 (Proposed Architecture)  
**Base URL:** `http://localhost:4000/api`  
**Authentication:** Bearer Token (JWT) / better-auth sessions  
**Date:** February 2, 2026

---

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [Authentication Flow](#authentication-flow)
3. [API Routes Reference](#api-routes-reference)
4. [Detailed Route Logic](#detailed-route-logic)
5. [Database Operations](#database-operations)
6. [Error Handling](#error-handling)
7. [Validation Schemas](#validation-schemas)

---

## Architecture Overview

### Layer Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      HTTP REQUEST                           â”‚
â”‚                    (Client â†’ Server)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MIDDLEWARE LAYER                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   CORS       â”‚  â”‚  Rate Limit  â”‚  â”‚   Logger     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Body Parser â”‚  â”‚  Validation  â”‚  â”‚  Auth Guard  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ROUTING LAYER                             â”‚
â”‚  /api/auth          â†’ AuthRouter                            â”‚
â”‚  /api/users         â†’ UsersRouter                           â”‚
â”‚  /api/complaints    â†’ ComplaintsRouter                      â”‚
â”‚  /api/teams         â†’ TeamsRouter                           â”‚
â”‚  /api/wards         â†’ WardsRouter                           â”‚
â”‚  /api/analytics     â†’ AnalyticsRouter                       â”‚
â”‚  /api/notifications â†’ NotificationsRouter                   â”‚
â”‚  /api/settings      â†’ SettingsRouter                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CONTROLLER LAYER                           â”‚
â”‚  â€¢ Parse request                                            â”‚
â”‚  â€¢ Validate input (Zod schemas)                             â”‚
â”‚  â€¢ Call service methods                                     â”‚
â”‚  â€¢ Format response                                          â”‚
â”‚  â€¢ Handle errors                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SERVICE LAYER                             â”‚
â”‚  â€¢ Business logic                                           â”‚
â”‚  â€¢ Data transformation                                      â”‚
â”‚  â€¢ Call repository/database                                 â”‚
â”‚  â€¢ External API calls                                       â”‚
â”‚  â€¢ Transaction management                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  DATABASE LAYER                             â”‚
â”‚  â€¢ Prisma ORM                                               â”‚
â”‚  â€¢ PostgreSQL                                               â”‚
â”‚  â€¢ Query optimization                                       â”‚
â”‚  â€¢ Relationships                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   HTTP RESPONSE                             â”‚
â”‚                  (Server â†’ Client)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Authentication Flow

### Login Flow (Email/Password)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚                                    â”‚   Backend    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                  â”‚
     â”‚  POST /api/auth/login                           â”‚
     â”‚  { email, password }                            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚                                                  â”‚
     â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                    â”‚  AuthController.login()  â”‚
     â”‚                                    â”‚  1. Extract credentials  â”‚
     â”‚                                    â”‚  2. Call AuthService     â”‚
     â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                  â”‚
     â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                    â”‚   AuthService.login()    â”‚
     â”‚                                    â”‚  1. Find user by email   â”‚
     â”‚                                    â”‚  2. Compare password     â”‚
     â”‚                                    â”‚  3. Generate tokens      â”‚
     â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                  â”‚
     â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                    â”‚   Database Query         â”‚
     â”‚                                    â”‚   db.user.findUnique()   â”‚
     â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                  â”‚
     â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                    â”‚   bcrypt.compare()       â”‚
     â”‚                                    â”‚   Validate password      â”‚
     â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                  â”‚
     â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                    â”‚   Generate JWT Tokens    â”‚
     â”‚                                    â”‚   â€¢ Access Token         â”‚
     â”‚                                    â”‚   â€¢ Refresh Token        â”‚
     â”‚                                    â”‚   Save refresh to DB     â”‚
     â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                  â”‚
     â”‚  200 OK                                         â”‚
     â”‚  {                                              â”‚
     â”‚    success: true,                               â”‚
     â”‚    data: {                                      â”‚
     â”‚      user: {...},                               â”‚
     â”‚      accessToken: "...",                        â”‚
     â”‚      refreshToken: "..."                        â”‚
     â”‚    }                                            â”‚
     â”‚  }                                              â”‚
     <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                  â”‚
```

### OAuth Flow (Google/GitHub)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚          â”‚   Backend    â”‚          â”‚   OAuth      â”‚
â”‚          â”‚          â”‚              â”‚          â”‚   Provider   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                       â”‚                         â”‚
     â”‚  GET /auth/google     â”‚                         â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
     â”‚                       â”‚                         â”‚
     â”‚                       â”‚  Redirect to Google     â”‚
     â”‚                       â”‚  with client_id         â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
     â”‚                       â”‚                         â”‚
     â”‚  User authenticates                             â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                       â”‚                         â”‚
     â”‚  Redirect with code                             â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                       â”‚                         â”‚
     â”‚  GET /auth/callback   â”‚                         â”‚
     â”‚  ?code=xxx            â”‚                         â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
     â”‚                       â”‚  Exchange code          â”‚
     â”‚                       â”‚  for access token       â”‚
     â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                       â”‚                         â”‚
     â”‚                       â”‚  Access Token           â”‚
     â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                       â”‚                         â”‚
     â”‚                       â”‚  Get user profile       â”‚
     â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                       â”‚                         â”‚
     â”‚                       â”‚  User data              â”‚
     â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                       â”‚                         â”‚
     â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
     â”‚               â”‚ Create/Update  â”‚                â”‚
     â”‚               â”‚ User in DB     â”‚                â”‚
     â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
     â”‚                       â”‚                         â”‚
     â”‚  Set session cookie   â”‚                         â”‚
     â”‚  Redirect to app      â”‚                         â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
     â”‚                       â”‚                         â”‚
```

### Protected Route Authentication

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚                                    â”‚   Backend    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                  â”‚
     â”‚  GET /api/complaints                            â”‚
     â”‚  Authorization: Bearer <token>                  â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
     â”‚                                                  â”‚
     â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                    â”‚  AuthMiddleware          â”‚
     â”‚                                    â”‚  1. Extract token        â”‚
     â”‚                                    â”‚  2. Verify JWT signature â”‚
     â”‚                                    â”‚  3. Check expiration     â”‚
     â”‚                                    â”‚  4. Decode payload       â”‚
     â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                  â”‚
     â”‚                                           [Valid?]
     â”‚                                            /        \
     â”‚                                          YES        NO
     â”‚                                           â”‚          â”‚
     â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
     â”‚                                    â”‚ Attach  â”‚  â”‚  401    â”‚
     â”‚                                    â”‚ userId  â”‚  â”‚  Error  â”‚
     â”‚                                    â”‚ to req  â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜      â”‚
     â”‚                                           â”‚         â”‚
     â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”‚
     â”‚                                    â”‚  Controller â”‚  â”‚
     â”‚                                    â”‚  Handler    â”‚  â”‚
     â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
     â”‚                                                     â”‚
     â”‚  401 Unauthorized                                  â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
```

---

## API Routes Reference

### ğŸ“‹ Quick Reference Table

| Method | Route | Auth | Description |
|--------|-------|------|-------------|
| **AUTH** |
| POST | `/auth/login` | âŒ | Login with email/password |
| POST | `/auth/register` | âŒ | Register new user |
| POST | `/auth/logout` | âœ… | Logout and invalidate tokens |
| POST | `/auth/refresh` | âŒ | Refresh access token |
| GET | `/auth/google` | âŒ | OAuth login with Google |
| GET | `/auth/github` | âŒ | OAuth login with GitHub |
| **USERS** |
| GET | `/users/profile` | âœ… | Get current user profile |
| PUT | `/users/profile` | âœ… | Update current user profile |
| GET | `/users/:id` | âœ… | Get user by ID (admin) |
| GET | `/users` | âœ… | List all users (admin) |
| PUT | `/users/:id/role` | âœ… | Update user role (admin) |
| DELETE | `/users/:id` | âœ… | Delete user (admin) |
| **COMPLAINTS** |
| POST | `/complaints` | âœ… | Create new complaint |
| GET | `/complaints` | âœ… | List complaints (filtered) |
| GET | `/complaints/:id` | âœ… | Get complaint details |
| PUT | `/complaints/:id` | âœ… | Update complaint |
| DELETE | `/complaints/:id` | âœ… | Delete complaint (admin) |
| POST | `/complaints/:id/assign` | âœ… | Assign team to complaint |
| PUT | `/complaints/:id/status` | âœ… | Update complaint status |
| POST | `/complaints/:id/upvote` | âœ… | Upvote complaint |
| DELETE | `/complaints/:id/upvote` | âœ… | Remove upvote |
| GET | `/complaints/nearby` | âŒ | Get nearby complaints |
| GET | `/complaints/my-complaints` | âœ… | Get user's complaints |
| POST | `/complaints/:id/images` | âœ… | Add images to complaint |
| POST | `/complaints/:id/feedback` | âœ… | Add feedback |
| **TEAMS** |
| POST | `/teams` | âœ… | Create new team (admin) |
| GET | `/teams` | âœ… | List all teams |
| GET | `/teams/:id` | âœ… | Get team details |
| PUT | `/teams/:id` | âœ… | Update team (admin) |
| DELETE | `/teams/:id` | âœ… | Delete team (admin) |
| POST | `/teams/:id/members` | âœ… | Add team member (admin) |
| DELETE | `/teams/:id/members/:userId` | âœ… | Remove team member (admin) |
| GET | `/teams/:id/performance` | âœ… | Get team performance metrics |
| GET | `/teams/:id/assignments` | âœ… | Get team's assigned complaints |
| PUT | `/teams/:id/availability` | âœ… | Update team availability |
| **WARDS** |
| POST | `/wards` | âœ… | Create ward (admin) |
| GET | `/wards` | âŒ | List all wards |
| GET | `/wards/:id` | âŒ | Get ward details |
| PUT | `/wards/:id` | âœ… | Update ward (admin) |
| DELETE | `/wards/:id` | âœ… | Delete ward (admin) |
| GET | `/wards/:id/statistics` | âœ… | Get ward statistics |
| **ANALYTICS** |
| GET | `/analytics/overview` | âœ… | Get dashboard overview |
| GET | `/analytics/complaints` | âœ… | Complaint analytics |
| GET | `/analytics/teams` | âœ… | Team performance analytics |
| GET | `/analytics/trends` | âœ… | Time-based trends |
| GET | `/analytics/geographic` | âœ… | Geographic distribution |
| **NOTIFICATIONS** |
| GET | `/notifications` | âœ… | Get user notifications |
| PUT | `/notifications/:id/read` | âœ… | Mark as read |
| PUT | `/notifications/read-all` | âœ… | Mark all as read |
| DELETE | `/notifications/:id` | âœ… | Delete notification |
| **SETTINGS** |
| GET | `/settings` | âœ… | Get user settings |
| PUT | `/settings` | âœ… | Update user settings |
| GET | `/settings/system` | âœ… | Get system settings (admin) |
| PUT | `/settings/system` | âœ… | Update system settings (admin) |

---

## Detailed Route Logic

### 1. AUTH ROUTES

#### POST `/api/auth/register`

**Purpose:** Register a new user account

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     REGISTRATION FLOW                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Request Body:
{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "full_name": "John Doe",
  "phone": "+1234567890",
  "role": "citizen" // Optional, default: citizen
}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: Validation (Zod Schema)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ“ Email format valid                                        â”‚
â”‚  âœ“ Password min 8 chars, has uppercase, lowercase, number   â”‚
â”‚  âœ“ Full name min 2 chars                                    â”‚
â”‚  âœ“ Phone format valid (optional)                            â”‚
â”‚  âœ“ Role is valid enum value                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Check if Email Already Exists                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  db.user.findUnique({                                        â”‚
â”‚    where: { email: email.toLowerCase() }                    â”‚
â”‚  })                                                          â”‚
â”‚                                                              â”‚
â”‚  If exists â†’ 409 Conflict Error                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: Hash Password                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  const hashedPassword = await bcrypt.hash(password, 10);    â”‚
â”‚  // Salt rounds: 10                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: Create User in Database                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  const user = await db.user.create({                        â”‚
â”‚    data: {                                                  â”‚
â”‚      email: email.toLowerCase(),                           â”‚
â”‚      password: hashedPassword,                             â”‚
â”‚      full_name,                                            â”‚
â”‚      phone,                                                â”‚
â”‚      role,                                                 â”‚
â”‚      is_active: true,                                      â”‚
â”‚      is_email_verified: false                              â”‚
â”‚    }                                                        â”‚
â”‚  });                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: Generate JWT Tokens                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  const accessToken = jwt.sign(                              â”‚
â”‚    { userId: user.id, role: user.role },                   â”‚
â”‚    process.env.JWT_SECRET,                                 â”‚
â”‚    { expiresIn: '15m' }                                    â”‚
â”‚  );                                                         â”‚
â”‚                                                             â”‚
â”‚  const refreshToken = jwt.sign(                            â”‚
â”‚    { userId: user.id },                                    â”‚
â”‚    process.env.JWT_REFRESH_SECRET,                         â”‚
â”‚    { expiresIn: '7d' }                                     â”‚
â”‚  );                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: Save Refresh Token to Database                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  await db.refreshToken.create({                             â”‚
â”‚    data: {                                                  â”‚
â”‚      user_id: user.id,                                     â”‚
â”‚      token: refreshToken,                                  â”‚
â”‚      expires_at: new Date(Date.now() + 7*24*60*60*1000)   â”‚
â”‚    }                                                        â”‚
â”‚  });                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 7: Send Response                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  {                                                          â”‚
â”‚    "success": true,                                        â”‚
â”‚    "message": "Registration successful",                   â”‚
â”‚    "data": {                                               â”‚
â”‚      "user": {                                             â”‚
â”‚        "id": "uuid",                                       â”‚
â”‚        "email": "user@example.com",                        â”‚
â”‚        "full_name": "John Doe",                           â”‚
â”‚        "role": "citizen"                                   â”‚
â”‚      },                                                    â”‚
â”‚      "accessToken": "eyJhbGc...",                         â”‚
â”‚      "refreshToken": "eyJhbGc..."                         â”‚
â”‚    }                                                       â”‚
â”‚  }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Status Codes:
  201 Created     - User registered successfully
  400 Bad Request - Validation failed
  409 Conflict    - Email already exists
  500 Server Error - Database or hashing error
```

---

#### POST `/api/auth/login`

**Purpose:** Authenticate user and return tokens

```
Request Body:
{
  "email": "user@example.com",
  "password": "SecurePass123!"
}

Flow:
  1. Validate input
  2. Find user by email (case-insensitive)
     â†’ db.user.findUnique({ where: { email: email.toLowerCase() }})
  3. Check if user exists
     â†’ If not: 401 Unauthorized
  4. Check if user is active
     â†’ If !is_active: 403 Forbidden
  5. Compare password hash
     â†’ const isValid = await bcrypt.compare(password, user.password)
     â†’ If invalid: 401 Unauthorized
  6. Generate tokens (same as register)
  7. Save refresh token
  8. Update user.last_login_at
  9. Return user data + tokens

Response (200 OK):
{
  "success": true,
  "data": {
    "user": {
      "id": "uuid",
      "email": "user@example.com",
      "full_name": "John Doe",
      "role": "citizen",
      "profile_image_url": "https://..."
    },
    "accessToken": "eyJhbGc...",
    "refreshToken": "eyJhbGc..."
  }
}
```

---

### 2. COMPLAINT ROUTES

#### POST `/api/complaints`

**Purpose:** Create a new complaint

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               COMPLAINT CREATION FLOW                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Request Body:
{
  "title": "Large pothole on Main Street",
  "description": "Deep pothole causing traffic issues",
  "location_address": "123 Main St, Mumbai",
  "landmark": "Near City Hall",
  "latitude": 19.0760,
  "longitude": 72.8777,
  "category": "pothole",
  "images": [
    "https://cloudinary.com/image1.jpg",
    "https://cloudinary.com/image2.jpg"
  ],
  "is_anonymous": false
}

Authorization: Bearer <token>
User ID extracted from token: "user-uuid-123"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: Validate Input                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ“ title: min 5 chars, max 200 chars                       â”‚
â”‚  âœ“ description: min 10 chars                               â”‚
â”‚  âœ“ location_address: required                              â”‚
â”‚  âœ“ latitude: number, valid range (-90 to 90)              â”‚
â”‚  âœ“ longitude: number, valid range (-180 to 180)           â”‚
â”‚  âœ“ category: enum (pothole, streetlight, garbage, etc)    â”‚
â”‚  âœ“ images: array of URLs (max 5)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Generate Complaint Number                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  const date = new Date().toISOString().slice(0,10)         â”‚
â”‚  const randomId = crypto.randomUUID().split('-')[0]        â”‚
â”‚  const complaintNumber = `CMP${date}-${randomId}`          â”‚
â”‚  // Example: CMP20260202-A3F7B9C2                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: Determine Ward (Optional AI Enhancement)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  // Find ward based on coordinates                          â”‚
â”‚  const ward = await findWardByCoordinates(lat, lng);       â”‚
â”‚  // Or manual ward assignment                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: AI Image Validation (If AI Service Available)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  for each image_url in images:                              â”‚
â”‚    const aiResult = await aiService.validateImage({        â”‚
â”‚      image_url,                                            â”‚
â”‚      category                                              â”‚
â”‚    });                                                     â”‚
â”‚                                                            â”‚
â”‚    // AI returns:                                          â”‚
â”‚    {                                                       â”‚
â”‚      is_valid: true,                                      â”‚
â”‚      severity: "High",                                    â”‚
â”‚      confidence: 0.92,                                    â”‚
â”‚      is_duplicate: false,                                 â”‚
â”‚      duplicate_of: null                                   â”‚
â”‚    }                                                       â”‚
â”‚                                                            â”‚
â”‚  If is_duplicate: link to original complaint              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: Create Complaint (Database Transaction)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  await db.$transaction(async (tx) => {                     â”‚
â”‚                                                             â”‚
â”‚    // Create complaint                                     â”‚
â”‚    const complaint = await tx.complaint.create({           â”‚
â”‚      data: {                                               â”‚
â”‚        complaint_number: complaintNumber,                  â”‚
â”‚        user_id: is_anonymous ? null : userId,             â”‚
â”‚        citizen_name: user.full_name,                      â”‚
â”‚        citizen_email: user.email,                         â”‚
â”‚        citizen_phone: user.phone,                         â”‚
â”‚        title,                                             â”‚
â”‚        description,                                        â”‚
â”‚        category,                                          â”‚
â”‚        location_address,                                   â”‚
â”‚        landmark,                                          â”‚
â”‚        latitude,                                          â”‚
â”‚        longitude,                                         â”‚
â”‚        ward_id: ward?.id,                                 â”‚
â”‚        severity: aiResult?.severity || 'Medium',          â”‚
â”‚        status: 'Submitted',                               â”‚
â”‚        priority: calculatePriority(severity)              â”‚
â”‚      }                                                     â”‚
â”‚    });                                                     â”‚
â”‚                                                            â”‚
â”‚    // Create image records                                â”‚
â”‚    for (let i = 0; i < images.length; i++) {             â”‚
â”‚      await tx.complaintImage.create({                     â”‚
â”‚        data: {                                            â”‚
â”‚          complaint_id: complaint.id,                      â”‚
â”‚          image_url: images[i],                           â”‚
â”‚          is_primary: i === 0,                            â”‚
â”‚          uploaded_by: userId                             â”‚
â”‚        }                                                  â”‚
â”‚      });                                                  â”‚
â”‚    }                                                      â”‚
â”‚                                                           â”‚
â”‚    // Increment user's total_reports                     â”‚
â”‚    if (!is_anonymous) {                                  â”‚
â”‚      await tx.user.update({                              â”‚
â”‚        where: { id: userId },                            â”‚
â”‚        data: { total_reports: { increment: 1 }}          â”‚
â”‚      });                                                 â”‚
â”‚    }                                                     â”‚
â”‚                                                          â”‚
â”‚    return complaint;                                     â”‚
â”‚  });                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: Create Notifications                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  // Notify ward officer                                     â”‚
â”‚  if (ward && ward.ward_officer_id) {                       â”‚
â”‚    await notificationService.create({                      â”‚
â”‚      user_id: ward.ward_officer_id,                       â”‚
â”‚      type: 'new_complaint',                               â”‚
â”‚      title: 'New Complaint in Your Ward',                 â”‚
â”‚      body: `${category} reported at ${location_address}`, â”‚
â”‚      related_complaint_id: complaint.id                   â”‚
â”‚    });                                                     â”‚
â”‚  }                                                         â”‚
â”‚                                                            â”‚
â”‚  // Emit WebSocket event                                  â”‚
â”‚  io.emit('complaint:created', {                           â”‚
â”‚    complaint_id: complaint.id,                            â”‚
â”‚    ward_id: ward?.id,                                     â”‚
â”‚    severity: complaint.severity                           â”‚
â”‚  });                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 7: Return Response                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  {                                                          â”‚
â”‚    "success": true,                                        â”‚
â”‚    "message": "Complaint submitted successfully",         â”‚
â”‚    "data": {                                               â”‚
â”‚      "complaint_id": 123,                                 â”‚
â”‚      "complaint_number": "CMP20260202-A3F7B9C2",          â”‚
â”‚      "status": "Submitted",                               â”‚
â”‚      "severity": "High",                                  â”‚
â”‚      "created_at": "2026-02-02T10:30:00Z",               â”‚
â”‚      "estimated_resolution": "2026-02-05T10:30:00Z"      â”‚
â”‚    }                                                       â”‚
â”‚  }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### GET `/api/complaints`

**Purpose:** List complaints with filtering and pagination

```
Query Parameters:
?page=1
&limit=20
&status=Submitted,Under_Review
&severity=Critical,High
&ward_id=5
&team_id=3
&date_from=2026-01-01
&date_to=2026-02-02
&search=pothole

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QUERY BUILDING LOGIC                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

const where = {};

// Status filter (multiple allowed)
if (status) {
  where.status = { in: status.split(',') };
}

// Severity filter
if (severity) {
  where.severity = { in: severity.split(',') };
}

// Ward filter
if (ward_id) {
  where.ward_id = parseInt(ward_id);
}

// Team filter
if (team_id) {
  where.assigned_to_team_id = parseInt(team_id);
}

// Date range filter
if (date_from || date_to) {
  where.created_at = {};
  if (date_from) where.created_at.gte = new Date(date_from);
  if (date_to) where.created_at.lte = new Date(date_to);
}

// Search filter (title or description)
if (search) {
  where.OR = [
    { title: { contains: search, mode: 'insensitive' }},
    { description: { contains: search, mode: 'insensitive' }},
    { location_address: { contains: search, mode: 'insensitive' }}
  ];
}

// Role-based filtering
if (user.role === 'field_officer') {
  // Only show complaints assigned to their team
  const userTeams = await db.teamMember.findMany({
    where: { user_id: user.id },
    select: { team_id: true }
  });
  where.assigned_to_team_id = { 
    in: userTeams.map(t => t.team_id) 
  };
}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE QUERY                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

const [complaints, total] = await Promise.all([
  db.complaint.findMany({
    where,
    skip: (page - 1) * limit,
    take: limit,
    orderBy: [
      { severity: 'asc' }, // Critical first
      { created_at: 'desc' }
    ],
    include: {
      images: {
        where: { is_primary: true },
        take: 1
      },
      assignedTeam: {
        select: {
          id: true,
          team_name: true,
          team_code: true
        }
      },
      ward: {
        select: {
          id: true,
          ward_number: true,
          ward_name: true
        }
      },
      _count: {
        select: { upvotes: true }
      }
    }
  }),
  db.complaint.count({ where })
]);

Response (200 OK):
{
  "success": true,
  "data": {
    "complaints": [
      {
        "id": 123,
        "complaint_number": "CMP20260202-A3F7B9C2",
        "title": "Large pothole on Main Street",
        "status": "Submitted",
        "severity": "High",
        "priority": "Urgent",
        "location_address": "123 Main St",
        "latitude": 19.0760,
        "longitude": 72.8777,
        "created_at": "2026-02-02T10:30:00Z",
        "upvotes_count": 15,
        "images": [
          {
            "image_url": "https://cloudinary.com/image1.jpg"
          }
        ],
        "assignedTeam": {
          "id": 3,
          "team_name": "Road Repair Team A",
          "team_code": "RRT-A"
        },
        "ward": {
          "id": 5,
          "ward_number": "W-05",
          "ward_name": "Central Ward"
        }
      }
    ],
    "pagination": {
      "current_page": 1,
      "total_pages": 5,
      "total_items": 98,
      "items_per_page": 20
    },
    "filters_applied": {
      "status": ["Submitted", "Under_Review"],
      "severity": ["Critical", "High"],
      "ward_id": 5
    }
  }
}
```

---

#### POST `/api/complaints/:id/assign`

**Purpose:** Assign a team to a complaint (with auto-assignment option)

```
Request Body:
{
  "team_id": 3,           // Optional: Specific team
  "auto_assign": false,   // Optional: Auto-select best team
  "notes": "Urgent - main road blocked"
}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             TEAM ASSIGNMENT LOGIC                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP 1: Get Complaint Details
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const complaint = await db.complaint.findUnique({
  where: { id: complaintId },
  include: {
    ward: true
  }
});

Checks:
  âœ“ Complaint exists
  âœ“ Complaint status is not 'Completed' or 'Rejected'
  âœ“ User has permission (admin or ward officer)

STEP 2: Determine Team
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
IF auto_assign === true:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  AUTO-ASSIGNMENT ALGORITHM                             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  1. Get all teams covering the ward                    â”‚
  â”‚     const teams = await db.repairTeam.findMany({      â”‚
  â”‚       where: {                                         â”‚
  â”‚         is_active: true,                              â”‚
  â”‚         is_available: true,                           â”‚
  â”‚         OR: [                                          â”‚
  â”‚           { primary_ward_id: complaint.ward_id },     â”‚
  â”‚           { coverage_wards: {                         â”‚
  â”‚               some: { id: complaint.ward_id }         â”‚
  â”‚             }}                                         â”‚
  â”‚         ]                                              â”‚
  â”‚       }                                                â”‚
  â”‚     });                                                â”‚
  â”‚                                                        â”‚
  â”‚  2. Filter by capacity                                â”‚
  â”‚     const available = teams.filter(t =>               â”‚
  â”‚       t.current_load < t.max_capacity                 â”‚
  â”‚     );                                                 â”‚
  â”‚                                                        â”‚
  â”‚  3. Sort by workload (ascending)                      â”‚
  â”‚     available.sort((a, b) =>                          â”‚
  â”‚       a.current_load - b.current_load                 â”‚
  â”‚     );                                                 â”‚
  â”‚                                                        â”‚
  â”‚  4. Consider severity                                 â”‚
  â”‚     If severity === 'Critical':                       â”‚
  â”‚       Prioritize teams with best performance          â”‚
  â”‚                                                        â”‚
  â”‚  5. Select best team                                  â”‚
  â”‚     selectedTeam = available[0];                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ELSE:
  Use provided team_id

STEP 3: Validate Team Selection
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ Team exists
âœ“ Team is active
âœ“ Team has capacity (current_load < max_capacity)
âœ“ Team covers the complaint's ward

STEP 4: Update Database (Transaction)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
await db.$transaction(async (tx) => {
  
  // Update complaint
  const updatedComplaint = await tx.complaint.update({
    where: { id: complaintId },
    data: {
      assigned_to_team_id: selectedTeam.id,
      assigned_by: userId,
      status: 'Assigned',
      target_resolution_date: calculateSLA(complaint.severity)
    }
  });

  // Increment team's workload
  await tx.repairTeam.update({
    where: { id: selectedTeam.id },
    data: {
      current_load: { increment: 1 }
    }
  });

  // Create assignment history
  await tx.complaintUpdate.create({
    data: {
      complaint_id: complaintId,
      updated_by: userId,
      update_type: 'team_assigned',
      message: `Assigned to ${selectedTeam.team_name}`
    }
  });

  return updatedComplaint;
});

STEP 5: Notify Team Members
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const teamMembers = await db.teamMember.findMany({
  where: { team_id: selectedTeam.id, is_active: true },
  include: { user: true }
});

for (const member of teamMembers) {
  await notificationService.create({
    user_id: member.user_id,
    type: 'new_assignment',
    title: 'New Complaint Assigned',
    body: `${complaint.title} - ${complaint.location_address}`,
    related_complaint_id: complaintId
  });
}

// Emit WebSocket event
io.to(`team:${selectedTeam.id}`).emit('complaint:assigned', {
  complaint_id: complaintId,
  complaint_number: complaint.complaint_number,
  severity: complaint.severity
});

STEP 6: Return Response
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Response (200 OK):
{
  "success": true,
  "message": "Team assigned successfully",
  "data": {
    "complaint_id": 123,
    "assigned_team": {
      "id": 3,
      "team_name": "Road Repair Team A",
      "team_code": "RRT-A",
      "current_load": 8,
      "max_capacity": 15
    },
    "status": "Assigned",
    "target_resolution_date": "2026-02-05T10:30:00Z",
    "auto_assigned": true
  }
}
```

---

### 3. TEAM ROUTES

#### POST `/api/teams`

**Purpose:** Create a new repair team (Admin only)

```
Request Body:
{
  "team_name": "Road Repair Team C",
  "team_code": "RRT-C",
  "team_leader_id": "user-uuid-456",
  "max_capacity": 15,
  "primary_ward_id": 5,
  "coverage_ward_ids": [5, 6, 7],
  "contact_phone": "+1234567890",
  "contact_email": "rrt-c@civic.com"
}

Validation:
  âœ“ team_code must be unique
  âœ“ team_leader_id must be a field_officer role
  âœ“ primary_ward_id must exist
  âœ“ coverage_ward_ids must all exist
  âœ“ max_capacity must be positive integer

Database Operation:
  const team = await db.repairTeam.create({
    data: {
      team_name,
      team_code,
      team_leader_id,
      max_capacity,
      primary_ward_id,
      coverage_wards: {
        connect: coverage_ward_ids.map(id => ({ id }))
      },
      contact_phone,
      contact_email,
      is_active: true,
      is_available: true,
      current_load: 0
    },
    include: {
      primary_ward: true,
      coverage_wards: true,
      team_leader: {
        select: {
          id: true,
          full_name: true,
          email: true
        }
      }
    }
  });

Response (201 Created):
{
  "success": true,
  "message": "Team created successfully",
  "data": {
    "id": 5,
    "team_name": "Road Repair Team C",
    "team_code": "RRT-C",
    "max_capacity": 15,
    "current_load": 0,
    "is_available": true,
    "primary_ward": {
      "id": 5,
      "ward_name": "Central Ward"
    },
    "coverage_wards": [
      { "id": 5, "ward_name": "Central Ward" },
      { "id": 6, "ward_name": "East Ward" },
      { "id": 7, "ward_name": "West Ward" }
    ],
    "team_leader": {
      "id": "user-uuid-456",
      "full_name": "Sarah Johnson",
      "email": "sarah@civic.com"
    }
  }
}
```

---

#### POST `/api/teams/:id/members`

**Purpose:** Add a member to a team

```
Request Body:
{
  "user_id": "user-uuid-789",
  "role": "member" // or "specialist", "leader"
}

Validation:
  âœ“ User exists and has field_officer role
  âœ“ User not already in team
  âœ“ Team exists and is active

Database Operation:
  await db.teamMember.create({
    data: {
      team_id: teamId,
      user_id,
      role,
      is_active: true,
      joined_at: new Date()
    }
  });

Response (201 Created):
{
  "success": true,
  "message": "Member added to team",
  "data": {
    "team_id": 5,
    "member": {
      "user_id": "user-uuid-789",
      "full_name": "Mike Chen",
      "role": "member",
      "joined_at": "2026-02-02T10:30:00Z"
    }
  }
}
```

---

#### GET `/api/teams/:id/performance`

**Purpose:** Get team performance metrics

```
Query Parameters:
?date_from=2026-01-01
&date_to=2026-02-02

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           TEAM PERFORMANCE CALCULATION                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

const team = await db.repairTeam.findUnique({
  where: { id: teamId },
  include: {
    assignedComplaints: {
      where: {
        created_at: { gte: date_from, lte: date_to }
      },
      select: {
        id: true,
        status: true,
        severity: true,
        created_at: true,
        target_resolution_date: true,
        actual_resolution_date: true
      }
    }
  }
});

Metrics Calculation:

1. Total Assigned
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   total_assigned = team.assignedComplaints.length

2. Completed Count
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   completed = complaints.filter(c => c.status === 'Completed').length

3. In Progress
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   in_progress = complaints.filter(c => c.status === 'In_Progress').length

4. Average Resolution Time
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   completed_with_dates = complaints.filter(c => 
     c.status === 'Completed' && 
     c.actual_resolution_date
   );
   
   total_hours = completed_with_dates.reduce((sum, c) => {
     const hours = (c.actual_resolution_date - c.created_at) / (1000*60*60);
     return sum + hours;
   }, 0);
   
   avg_resolution_time = total_hours / completed_with_dates.length;

5. SLA Compliance
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   on_time = complaints.filter(c => 
     c.status === 'Completed' &&
     c.actual_resolution_date <= c.target_resolution_date
   ).length;
   
   sla_compliance_rate = (on_time / completed) * 100;

6. Quality Score (if feedback exists)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   const feedback = await db.complaintFeedback.findMany({
     where: {
       complaint_id: { in: complaint_ids }
     }
   });
   
   avg_rating = feedback.reduce((sum, f) => sum + f.rating, 0) / feedback.length;
   quality_score = (avg_rating / 5) * 100;

Response (200 OK):
{
  "success": true,
  "data": {
    "team_id": 5,
    "team_name": "Road Repair Team C",
    "period": {
      "from": "2026-01-01",
      "to": "2026-02-02"
    },
    "metrics": {
      "total_assigned": 45,
      "completed": 38,
      "in_progress": 5,
      "pending": 2,
      "completion_rate": 84.4,
      "avg_resolution_time_hours": 18.5,
      "sla_compliance_rate": 92.1,
      "quality_score": 87.5
    },
    "by_severity": {
      "Critical": { "assigned": 8, "completed": 7 },
      "High": { "assigned": 15, "completed": 13 },
      "Medium": { "assigned": 18, "completed": 15 },
      "Low": { "assigned": 4, "completed": 3 }
    },
    "trend": [
      { "date": "2026-01-01", "completed": 2 },
      { "date": "2026-01-02", "completed": 3 },
      // ... daily breakdown
    ]
  }
}
```

---

### 4. ANALYTICS ROUTES

#### GET `/api/analytics/overview`

**Purpose:** Dashboard overview with key metrics

```
Time Range: Last 30 days (default) or custom

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  METRICS AGGREGATION                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

const [
  totalComplaints,
  complaintsByStatus,
  complaintsBySeverity,
  avgResolutionTime,
  activeTeams,
  topPerformingTeams
] = await Promise.all([
  
  // 1. Total complaints
  db.complaint.count({
    where: { created_at: { gte: startDate }}
  }),

  // 2. Breakdown by status
  db.complaint.groupBy({
    by: ['status'],
    where: { created_at: { gte: startDate }},
    _count: true
  }),

  // 3. Breakdown by severity
  db.complaint.groupBy({
    by: ['severity'],
    where: { created_at: { gte: startDate }},
    _count: true
  }),

  // 4. Average resolution time
  db.$queryRaw`
    SELECT AVG(
      EXTRACT(EPOCH FROM (actual_resolution_date - created_at)) / 3600
    ) as avg_hours
    FROM complaints
    WHERE status = 'Completed'
    AND actual_resolution_date IS NOT NULL
    AND created_at >= ${startDate}
  `,

  // 5. Active teams count
  db.repairTeam.count({
    where: { is_active: true }
  }),

  // 6. Top performing teams
  db.repairTeam.findMany({
    take: 5,
    orderBy: {
      assignedComplaints: {
        _count: 'desc'
      }
    },
    include: {
      _count: {
        select: {
          assignedComplaints: {
            where: { status: 'Completed' }
          }
        }
      }
    }
  })
]);

Response (200 OK):
{
  "success": true,
  "data": {
    "period": {
      "from": "2026-01-03",
      "to": "2026-02-02",
      "days": 30
    },
    "overview": {
      "total_complaints": 287,
      "new_complaints": 45,
      "resolved_complaints": 198,
      "avg_resolution_time_hours": 22.3,
      "resolution_rate": 69.0,
      "active_teams": 8
    },
    "by_status": {
      "Submitted": 45,
      "Under_Review": 12,
      "Verified": 8,
      "Assigned": 15,
      "In_Progress": 9,
      "Completed": 198,
      "Rejected": 0
    },
    "by_severity": {
      "Critical": 23,
      "High": 87,
      "Medium": 145,
      "Low": 32
    },
    "top_teams": [
      {
        "id": 3,
        "team_name": "Road Repair Team A",
        "completed_count": 67,
        "completion_rate": 89.3
      }
    ],
    "trend": [
      {
        "date": "2026-01-03",
        "new": 8,
        "resolved": 6,
        "pending": 2
      }
      // ... daily data
    ]
  }
}
```

---

## Database Operations

### Common Query Patterns

#### 1. Filtered List with Pagination

```typescript
async function getComplaints(filters: ComplaintFilters) {
  const { page = 1, limit = 20, ...where } = filters;
  
  const [items, total] = await Promise.all([
    db.complaint.findMany({
      where,
      skip: (page - 1) * limit,
      take: limit,
      orderBy: { created_at: 'desc' },
      include: {
        images: { where: { is_primary: true }, take: 1 },
        assignedTeam: true,
        ward: true
      }
    }),
    db.complaint.count({ where })
  ]);

  return {
    items,
    pagination: {
      current_page: page,
      total_pages: Math.ceil(total / limit),
      total_items: total
    }
  };
}
```

#### 2. Transaction with Multiple Updates

```typescript
async function assignComplaintToTeam(complaintId: number, teamId: number) {
  return await db.$transaction(async (tx) => {
    // Update complaint
    const complaint = await tx.complaint.update({
      where: { id: complaintId },
      data: {
        assigned_to_team_id: teamId,
        status: 'Assigned'
      }
    });

    // Increment team load
    await tx.repairTeam.update({
      where: { id: teamId },
      data: { current_load: { increment: 1 }}
    });

    // Create history entry
    await tx.complaintUpdate.create({
      data: {
        complaint_id: complaintId,
        update_type: 'team_assigned',
        message: `Assigned to team ${teamId}`
      }
    });

    return complaint;
  });
}
```

#### 3. Aggregation Query

```typescript
async function getComplaintStatsByWard() {
  return await db.complaint.groupBy({
    by: ['ward_id'],
    _count: {
      id: true
    },
    _avg: {
      // Can't avg enum, need raw query for complex aggregations
    },
    where: {
      created_at: {
        gte: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)
      }
    }
  });
}
```

---

## Error Handling

### Error Response Format

```typescript
// Standardized error response
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid input data",
    "details": [
      {
        "field": "email",
        "message": "Invalid email format"
      }
    ],
    "timestamp": "2026-02-02T10:30:00Z",
    "request_id": "req-uuid-123"
  }
}
```

### Error Codes

| Code | HTTP Status | Description |
|------|-------------|-------------|
| `VALIDATION_ERROR` | 400 | Input validation failed |
| `AUTHENTICATION_ERROR` | 401 | Invalid or missing token |
| `AUTHORIZATION_ERROR` | 403 | Insufficient permissions |
| `NOT_FOUND` | 404 | Resource not found |
| `CONFLICT` | 409 | Resource already exists |
| `RATE_LIMIT_EXCEEDED` | 429 | Too many requests |
| `INTERNAL_ERROR` | 500 | Server error |
| `DATABASE_ERROR` | 500 | Database operation failed |
| `EXTERNAL_SERVICE_ERROR` | 502 | Third-party service failed |

### Error Handling Middleware

```typescript
export function errorHandler(
  err: Error,
  req: Request,
  res: Response,
  next: NextFunction
) {
  const requestId = req.id || crypto.randomUUID();

  // Log error
  logger.error({
    request_id: requestId,
    error: err.message,
    stack: err.stack,
    path: req.path,
    method: req.method
  });

  // Handle specific error types
  if (err instanceof ValidationError) {
    return res.status(400).json({
      success: false,
      error: {
        code: 'VALIDATION_ERROR',
        message: err.message,
        details: err.errors,
        timestamp: new Date().toISOString(),
        request_id: requestId
      }
    });
  }

  if (err instanceof PrismaClientKnownRequestError) {
    if (err.code === 'P2002') {
      return res.status(409).json({
        success: false,
        error: {
          code: 'CONFLICT',
          message: 'Resource already exists',
          timestamp: new Date().toISOString(),
          request_id: requestId
        }
      });
    }
  }

  // Default error
  return res.status(500).json({
    success: false,
    error: {
      code: 'INTERNAL_ERROR',
      message: 'An unexpected error occurred',
      timestamp: new Date().toISOString(),
      request_id: requestId
    }
  });
}
```

---

## Validation Schemas

### Using Zod for Request Validation

```typescript
// schemas/complaint.schema.ts
import { z } from 'zod';

export const createComplaintSchema = z.object({
  title: z.string()
    .min(5, 'Title must be at least 5 characters')
    .max(200, 'Title must not exceed 200 characters'),
  
  description: z.string()
    .min(10, 'Description must be at least 10 characters'),
  
  location_address: z.string()
    .min(1, 'Location address is required'),
  
  landmark: z.string().optional(),
  
  latitude: z.number()
    .min(-90)
    .max(90),
  
  longitude: z.number()
    .min(-180)
    .max(180),
  
  category: z.enum([
    'pothole',
    'streetlight',
    'garbage',
    'drainage',
    'other'
  ]),
  
  images: z.array(z.string().url())
    .max(5, 'Maximum 5 images allowed')
    .optional()
    .default([]),
  
  is_anonymous: z.boolean()
    .optional()
    .default(false)
});

export type CreateComplaintDto = z.infer<typeof createComplaintSchema>;

// Validation middleware
export function validateRequest(schema: z.ZodSchema) {
  return (req: Request, res: Response, next: NextFunction) => {
    try {
      req.body = schema.parse(req.body);
      next();
    } catch (error) {
      if (error instanceof z.ZodError) {
        return res.status(400).json({
          success: false,
          error: {
            code: 'VALIDATION_ERROR',
            message: 'Invalid input data',
            details: error.errors.map(e => ({
              field: e.path.join('.'),
              message: e.message
            }))
          }
        });
      }
      next(error);
    }
  };
}

// Usage in route
router.post('/complaints', 
  authenticateUser,
  validateRequest(createComplaintSchema),
  ComplaintController.create
);
```

---

## Summary

This document provides a complete visual reference for the CivicConnect backend API, including:

âœ… **Layer Architecture** - Understanding request flow  
âœ… **Authentication Flows** - JWT and OAuth patterns  
âœ… **All Route Endpoints** - Complete API reference  
âœ… **Detailed Logic Flows** - Step-by-step processing  
âœ… **Database Operations** - Common query patterns  
âœ… **Error Handling** - Standardized responses  
âœ… **Validation Schemas** - Input validation with Zod  

### Key Patterns Used:

1. **Service Layer Pattern** - Business logic separated from controllers
2. **Repository Pattern** - Database operations abstracted
3. **Transaction Management** - Atomic operations with Prisma
4. **Input Validation** - Zod schemas for type-safe validation
5. **Error Handling** - Centralized error middleware
6. **Authentication** - JWT tokens with refresh mechanism
7. **Authorization** - Role-based access control
8. **Pagination** - Offset-based pagination
9. **Filtering** - Dynamic query building
10. **Real-time Updates** - WebSocket events

---

*Last Updated: February 2, 2026*  
*Version: 2.0 (Proposed Architecture)*
